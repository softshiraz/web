<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سینمای آنلاین خصوصی</title>
    <style>
        /* --- استایل‌های کلی --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* --- لایوت صفحه --- */
        #main-layout { display: flex; flex: 1; height: 100%; }
        #video-section { flex: 3; position: relative; display: flex; flex-direction: column; justify-content: center; background: #000; }
        #chat-section { flex: 1; border-right: 1px solid #333; display: flex; flex-direction: column; background: #1e1e1e; min-width: 300px; }

        /* --- ویدیو --- */
        video { width: 100%; max-height: 100%; outline: none; }
        #blocker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; } /* مانع کلیک */
        
        /* --- پنل ادمین --- */
        #admin-controls { padding: 10px; background: #2c2c2c; display: none; border-bottom: 1px solid #444; }
        #admin-controls input { width: 70%; padding: 8px; border-radius: 4px; border: none; background: #444; color: white; }
        #admin-controls button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* --- چت --- */
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #333; padding: 8px 12px; border-radius: 8px; font-size: 0.9em; max-width: 90%; }
        .msg strong { color: #4db6ac; display: block; margin-bottom: 4px; font-size: 0.8em; }
        .msg.mine { align-self: flex-end; background: #2e7d32; }
        
        #chat-input-area { padding: 15px; background: #252525; display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #444; color: white; }
        #send-btn { background: #00897b; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        #username-edit { padding: 5px 15px; font-size: 0.8em; color: #888; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #edit-name-btn { cursor: pointer; color: #4db6ac; text-decoration: underline; }

        /* --- مودال ورود (Login) --- */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: #2c2c2c; padding: 30px; border-radius: 10px; width: 300px; text-align: center; box-shadow: 0 0 20px rgba(0,255,200,0.1); }
        .login-box input { width: 90%; margin: 10px 0; padding: 12px; border-radius: 5px; border: 1px solid #444; background: #1a1a1a; color: white; }
        .login-box button { width: 100%; padding: 12px; margin-top: 10px; background: #00897b; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; }
        .error { color: #ff5252; margin-top: 10px; font-size: 0.9em; display: none; }

        /* ریسپانسیو برای موبایل */
        @media (max-width: 768px) {
            #main-layout { flex-direction: column; }
            #video-section { flex: 0 0 auto; }
            #chat-section { flex: 1; min-width: auto; }
            #admin-controls { display: flex; flex-direction: column; gap: 5px; }
            #admin-controls input { width: 95%; }
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2>ورود به سینما</h2>
            <input type="text" id="inpName" placeholder="نام نمایشی شما">
            <input type="password" id="inpPass" placeholder="رمز ورود (ادمین یا کاربر)">
            <button id="btnLogin">ورود به اتاق</button>
            <div class="error" id="loginError">رمز اشتباه است!</div>
        </div>
    </div>

    <div id="main-layout">
        <div id="video-section">
            <div id="admin-controls">
                <input type="text" id="urlInput" placeholder="لینک مستقیم ویدیو (mp4, mkv...)">
                <button id="changeUrlBtn">تغییر فیلم</button>
            </div>
            <video id="myVideo" playsinline>
                <source src="" type="video/mp4">
            </video>
            <div id="blocker"></div>
        </div>

        <div id="chat-section">
            <div id="username-edit">
                <span>کاربر: <span id="current-username">...</span></span>
                <span id="edit-name-btn">ویرایش نام</span>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="پیام...">
                <button id="send-btn">➤</button>
            </div>
        </div>
    </div>

<script type="module">
    // استفاده از نسخه پایدارتر
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const CONFIG = {
        adminPass: "1234", 
        userPass: "1111",   
    };

    const firebaseConfig = {
        apiKey: "AIzaSyCZVi8SyjtW6dxMHDX7D0lZEdF5XPLtwJA",
        authDomain: "softshiraz-2ddce.firebaseapp.com",
        databaseURL: "https://softshiraz-2ddce-default-rtdb.firebaseio.com/",
        projectId: "softshiraz-2ddce",
        storageBucket: "softshiraz-2ddce.firebasestorage.app",
        messagingSenderId: "760975223534",
        appId: "1:760975223534:web:3008a1fbcc09a2ae2fe1ff",
        measurementId: "G-MRLRFEVB3D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const roomRef = ref(db, 'cinema/status');
    const chatRef = ref(db, 'cinema/chat');

    let isAdmin = false;
    let myName = localStorage.getItem('chatName') || '';
    
    // المان‌ها
    const els = {
        video: document.getElementById('myVideo'),
        blocker: document.getElementById('blocker'),
        loginModal: document.getElementById('login-modal'),
        inpName: document.getElementById('inpName'),
        inpPass: document.getElementById('inpPass'),
        btnLogin: document.getElementById('btnLogin'),
        adminPanel: document.getElementById('admin-controls'),
        urlInput: document.getElementById('urlInput'),
        changeUrlBtn: document.getElementById('changeUrlBtn'),
        chatMsgs: document.getElementById('chat-messages'),
        chatInput: document.getElementById('chat-input'),
        sendBtn: document.getElementById('send-btn'),
        currentUsername: document.getElementById('current-username')
    };

    // ورود
    els.btnLogin.onclick = () => {
        const pass = els.inpPass.value;
        const name = els.inpName.value.trim();
        if (!name) return alert("نام وارد نشده");

        if (pass === CONFIG.adminPass) isAdmin = true;
        else if (pass === CONFIG.userPass) isAdmin = false;
        else return alert("رمز اشتباه");

        myName = name;
        localStorage.setItem('chatName', myName);
        els.currentUsername.innerText = myName;
        els.loginModal.style.display = 'none';

        // آنمیوت برای اجازه مرورگر
        els.video.muted = false;
        if(isAdmin) setupAdmin(); else setupViewer();
    };

    function setupAdmin() {
        els.adminPanel.style.display = 'block';
        els.video.controls = true;

        els.changeUrlBtn.onclick = () => {
            const url = els.urlInput.value;
            if(url) {
                set(roomRef, {
                    videoUrl: url,
                    timestamp: 0,
                    state: 'playing', // شروع خودکار
                    updatedAt: Date.now()
                });
            }
        };

        // آپدیت وضعیت زمان پخش
        els.video.onplay = () => syncAdmin('playing');
        els.video.onpause = () => syncAdmin('paused');
        els.video.onseeked = () => syncAdmin(els.video.paused ? 'paused' : 'playing');

        function syncAdmin(state) {
            update(roomRef, {
                state: state,
                timestamp: els.video.currentTime,
                updatedAt: Date.now()
            });
        }
    }

    function setupViewer() {
        els.blocker.style.display = 'block';
        
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // تغییر لینک فیلم برای کاربر
            if (data.videoUrl && els.video.src !== data.videoUrl) {
                els.video.src = data.videoUrl;
            }

            // محاسبه زمان دقیق حتی اگر ادمین آنلاین نباشد
            const timePassedSinceUpdate = (Date.now() - data.updatedAt) / 1000;
            let targetTime = data.timestamp;

            if (data.state === 'playing') {
                targetTime += timePassedSinceUpdate;
                els.video.play().catch(() => console.log("Click required"));
            } else {
                els.video.pause();
            }

            if (Math.abs(els.video.currentTime - targetTime) > 2) {
                els.video.currentTime = targetTime;
            }
        });
    }

    // چت (بدون تغییر، فقط آدرس ایمپورت اصلاح شد)
    els.sendBtn.onclick = () => {
        const text = els.chatInput.value.trim();
        if (text) {
            push(chatRef, { user: myName, text: text, time: Date.now() });
            els.chatInput.value = '';
        }
    };

    onChildAdded(chatRef, (snapshot) => {
        const msg = snapshot.val();
        const div = document.createElement('div');
        div.className = 'msg ' + (msg.user === myName ? 'mine' : '');
        div.innerHTML = `<strong>${msg.user}</strong>${msg.text}`;
        els.chatMsgs.appendChild(div);
        els.chatMsgs.scrollTop = els.chatMsgs.scrollHeight;
    });
</script>
</body>
</html>
