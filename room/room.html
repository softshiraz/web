<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت روم ایمن</title>
    <style>
        body { font-family: tahoma; background: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #auth-box, #chat-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 350px; }
        #chat-box { width: 90%; max-width: 500px; height: 80vh; display: none; flex-direction: column; }
        .hidden { display: none !important; }
        input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #messages { flex: 1; overflow-y: auto; border: 1px solid #eee; margin: 10px 0; padding: 10px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 8px; background: #e9ecef; position: relative; }
        .my-msg { background: #d1e7dd; align-self: flex-end; }
        .admin-msg { border: 2px solid #ffc107; }
        .delete-btn { color: red; cursor: pointer; font-size: 10px; float: left; }
        .user-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; color: #666; }
    </style>
</head>
<body>

    <div id="auth-box">
        <h3>ورود به چت</h3>
        <input type="text" id="username" placeholder="نام کاربری">
        <input type="password" id="password" placeholder="رمز عبور">
        <button onclick="login()">ورود</button>
        <p style="font-size: 11px;">رمز کاربر: 1404 | رمز مدیر: 1111</p>
    </div>

    <div id="chat-box">
        <div class="user-header">
            <span id="display-name"></span>
            <button onclick="logout()" style="background:#dc3545; padding:2px 5px; font-size:10px;">تغییر اسم (خروج)</button>
        </div>
        <div id="messages"></div>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="msgInput" placeholder="پیام...">
            <button onclick="send()">ارسال</button>
        </div>
    </div>

<script>
    const WORKER_URL = "https://room.softshiraz.workers.dev/";

    // بررسی ورود قبلی
    window.onload = () => {
        if(localStorage.getItem('chat_user')) {
            showChat();
        }
    };

    async function login() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if(!u || !p) return alert("فیلدها را پر کنید");

        const res = await fetch(WORKER_URL, {
            method: 'POST',
            body: JSON.stringify({ type: 'register', username: u, password: p })
        });

        if(res.ok) {
            localStorage.setItem('chat_user', u);
            localStorage.setItem('chat_pass', p);
            showChat();
        } else {
            const data = await res.json();
            alert(data.error || "خطا در ورود");
        }
    }

    function showChat() {
        document.getElementById('auth-box').classList.add('hidden');
        document.getElementById('chat-box').style.display = 'flex';
        document.getElementById('display-name').innerText = "خوش آمدی " + localStorage.getItem('chat_user');
        loadMessages();
        setInterval(loadMessages, 3000);
    }

    async function loadMessages() {
        const res = await fetch(WORKER_URL);
        const msgs = await res.json();
        const container = document.getElementById('messages');
        const myUser = localStorage.getItem('chat_user');
        const myPass = localStorage.getItem('chat_pass');

        container.innerHTML = msgs.map(m => `
            <div class="msg ${m.username === myUser ? 'my-msg' : ''} ${m.isAdmin ? 'admin-msg' : ''}">
                <b style="font-size:10px">${m.username} ${m.isAdmin ? '(مدیر)' : ''}</b>: ${m.text}
                ${myPass === '1111' ? `<span class="delete-btn" onclick="deleteMsg('${m.id}')">حذف</span>` : ''}
                <div style="font-size:8px; text-align:left">${m.time}</div>
            </div>
        `).join('');
    }

    async function send() {
        const input = document.getElementById('msgInput');
        if(!input.value) return;
        
        await fetch(WORKER_URL, {
            method: 'POST',
            body: JSON.stringify({
                username: localStorage.getItem('chat_user'),
                password: localStorage.getItem('chat_pass'),
                text: input.value
            })
        });
        input.value = '';
        loadMessages();
    }

    async function deleteMsg(id) {
        if(!confirm("حذف شود؟")) return;
        await fetch(WORKER_URL, {
            method: 'DELETE',
            body: JSON.stringify({ messageId: id, adminPassword: localStorage.getItem('chat_pass') })
        });
        loadMessages();
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }
</script>
</body>
</html>
