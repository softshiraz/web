<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± VIP Ø·Ù„Ø§ÛŒÛŒ</title>
    <style>
        :root { --gold: #d4af37; --black: #0d0d0d; --gray: #1a1a1a; }
        * { box-sizing: border-box; font-family: Tahoma, sans-serif; transition: 0.2s; }
        body { background: var(--black); color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; background: #000; }
        .card { background: var(--gray); padding: 25px; border-radius: 20px; border: 1px solid var(--gold); width: 100%; max-width: 380px; text-align: center; }
        .av-select { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .av-opt { width: 50px; height: 50px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .av-opt.active { border-color: var(--gold); transform: scale(1.1); box-shadow: 0 0 10px var(--gold); }
        
        input { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; border-radius: 10px; color: white; outline: none; }
        .btn { padding: 12px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: black; width: 100%; }

        header { padding: 10px; background: var(--gray); border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        #online-info { font-size: 10px; color: #4caf50; }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 15px; background: var(--gray); border-right: 3px solid var(--gold); align-self: flex-start; position: relative; }
        .my-msg { align-self: flex-end; border-right: none; border-left: 3px solid var(--gold); background: #333; }
        .msg-av { width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-left: 5px; }

        .input-bar { padding: 10px; background: var(--gray); display: flex; gap: 8px; align-items: center; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .icon-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        #m { flex: 1; padding: 10px; border-radius: 20px; background: #222; border: 1px solid #444; color: white; }

        .reply-tag { font-size: 10px; color: var(--gold); background: rgba(255,255,255,0.05); padding: 3px; border-radius: 5px; margin-bottom: 5px; border-right: 2px solid var(--gold); }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="card">
            <h2 style="color:var(--gold)">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØªÙ€Ø§Ù„Ø§Ø±</h2>
            <div class="av-select">
                <img src="https://api.dicebear.com/7.x/bottts/svg?seed=1" class="av-opt active" onclick="selAv(this, '1')">
                <img src="https://api.dicebear.com/7.x/bottts/svg?seed=2" class="av-opt" onclick="selAv(this, '2')">
                <img src="https://api.dicebear.com/7.x/bottts/svg?seed=3" class="av-opt" onclick="selAv(this, '3')">
                <img src="https://api.dicebear.com/7.x/bottts/svg?seed=4" class="av-opt" onclick="selAv(this, '4')">
            </div>
            <input type="text" id="u" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
            <input type="password" id="p" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <button class="btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø§Ø´Ø±Ø§ÙÛŒ</button>
        </div>
    </div>

    <div id="chat-page" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div id="online-info">Ø¢Ù†Ù„Ø§ÛŒÙ†: Û° Ù†ÙØ±</div>
            <button onclick="logout()" style="background:none; border:1px solid #ff4444; color:#ff4444; border-radius:5px; font-size:10px; padding:3px 8px; cursor:pointer">Ø®Ø±ÙˆØ¬</button>
        </header>
        
        <div style="display:flex; background:#000; padding:5px; gap:5px;">
            <button class="btn" id="b-gen" style="flex:1; font-size:11px;" onclick="setRoom('general')">Ø¹Ù…ÙˆÙ…ÛŒ</button>
            <button class="btn" id="b-vip" style="flex:1; font-size:11px; background:#333; color:white;" onclick="setRoom('vip')">Ø¨Ø®Ø´ ÙˆÛŒÚ˜Ù‡</button>
        </div>

        <div id="chat-area"></div>

        <div id="reply-info" style="display:none; background:#222; padding:5px 15px; font-size:11px; color:var(--gold); justify-content:space-between; align-items:center;">
            <span id="reply-to"></span> <b onclick="cancelReply()" style="cursor:pointer">âœ–</b>
        </div>

        <div class="input-bar">
            <button id="voice-btn" class="icon-btn" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
            <input type="text" id="m" placeholder="Ù¾ÛŒØ§Ù…..." autocomplete="off">
            <button class="btn" style="width:70px" onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let selectedAv = "1", currentRoom = "general", replyTo = null, isTyping = false;
    let recorder, chunks = [], refreshInt, heartInt;

    function selAv(el, id) {
        document.querySelectorAll('.av-opt').forEach(i => i.classList.remove('active'));
        el.classList.add('active'); selectedAv = id;
    }

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        if(!u || !p) return alert("Ù„Ø·ÙØ§ Ù†Ø§Ù… Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        const res = await fetch(API, { method:'POST', body: JSON.stringify({type:'login', password:p}) });
        if((await res.json()).success) {
            localStorage.setItem('chat_u', u); localStorage.setItem('chat_p', p); localStorage.setItem('chat_av', selectedAv);
            start();
        } else alert("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª (Û±Û±Û±Û± ÛŒØ§ Û±Û´Û°Û´)");
    }

    function start() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        heartInt = setInterval(() => {
            fetch(`${API}?room=${currentRoom}`, { method:'POST', body: JSON.stringify({
                type:'heartbeat', username: localStorage.getItem('chat_u'), av: localStorage.getItem('chat_av'), isTyping
            })});
        }, 8000);
        refreshInt = setInterval(refresh, 3000);
        refresh();
    }

    async function refresh() {
        try {
            const res = await fetch(`${API}?room=${currentRoom}`);
            const d = await res.json();
            const myU = localStorage.getItem('chat_u'), myP = localStorage.getItem('chat_p');

            document.getElementById('online-info').innerText = "ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†: " + d.onlineUsers.length + " Ù†ÙØ± (" + d.onlineUsers.map(u=>u.name).join('ØŒ ') + ")";

            const area = document.getElementById('chat-area');
            const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;

            area.innerHTML = d.messages.map(m => `
                <div class="msg ${m.username === myU ? 'my-msg' : ''}" onclick="setReply('${m.username}')">
                    <img class="msg-av" src="https://api.dicebear.com/7.x/bottts/svg?seed=${m.av}">
                    <b style="color:var(--gold); font-size:11px;">${m.username} ${m.isAdmin?'ğŸ‘‘':''}</b>
                    ${m.replyTo ? `<div class="reply-tag">â†© Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡: ${m.replyTo}</div>` : ''}
                    ${m.text ? `<div>${m.text}</div>` : ''}
                    ${m.audio ? `<audio controls src="${m.audio}" style="width:180px; height:30px; filter:sepia(1); margin-top:5px;"></audio>` : ''}
                    <div style="font-size:8px; opacity:0.5; margin-top:5px;">
                        ${m.time} ${myP==='1111' ? `<span onclick="del('${m.id}')" style="color:red; margin-right:10px; cursor:pointer">Ø­Ø°Ù</span>`:''}
                    </div>
                </div>
            `).join('');
            if(isBottom) area.scrollTop = area.scrollHeight;
        } catch(e){}
    }

    async function send() {
        const inp = document.getElementById('m'); if(!inp.value) return;
        const txt = inp.value; inp.value = "";
        await post({ text: txt }); cancelReply();
    }

    async function post(data) {
        await fetch(`${API}?room=${currentRoom}`, { method:'POST', body: JSON.stringify({
            username: localStorage.getItem('chat_u'), 
            password: localStorage.getItem('chat_p'),
            av: localStorage.getItem('chat_av'),
            ...data, replyTo
        })});
        refresh();
    }

    function setReply(u) { replyTo = u; document.getElementById('reply-info').style.display='flex'; document.getElementById('reply-to').innerText="Ù¾Ø§Ø³Ø® Ø¨Ù‡: " + u; }
    function cancelReply() { replyTo = null; document.getElementById('reply-info').style.display='none'; }
    function setRoom(r) { currentRoom = r; document.getElementById('b-gen').style.background = r==='general'?'var(--gold)':'#333'; document.getElementById('b-vip').style.background = r==='vip'?'var(--gold)':'#333'; refresh(); }
    
    function logout() { if(confirm("Ø¢ÛŒØ§ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ")){ clearInterval(refreshInt); clearInterval(heartInt); localStorage.clear(); location.reload(); } }

    async function startRec() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(s); chunks = [];
            document.getElementById('voice-btn').style.color = "red";
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const b = new Blob(chunks, { type: 'audio/webm' });
                const r = new FileReader(); r.readAsDataURL(b);
                r.onloadend = () => post({ audio: r.result });
                document.getElementById('voice-btn').style.color = "white";
            };
            recorder.start();
        } catch(e) { alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯."); }
    }
    function stopRec() { if(recorder && recorder.state !== "inactive") recorder.stop(); }
    async function del(id) { await fetch(`${API}?room=${currentRoom}`, { method:'DELETE', body: JSON.stringify({messageId:id, adminPassword:localStorage.getItem('chat_p')})}); refresh(); }

    document.getElementById('m').oninput = () => { isTyping=true; setTimeout(()=>isTyping=false, 2000); };
    document.getElementById('m').onkeypress = e => { if(e.key==='Enter') send(); };
    if(localStorage.getItem('chat_u')) start();
</script>
</body>
</html>
