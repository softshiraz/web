<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± VIP</title>
    <style>
        :root { --gold: #d4af37; --black: #0d0d0d; --gray: #1a1a1a; }
        * { box-sizing: border-box; font-family: Tahoma, sans-serif; transition: 0.2s; }
        body { background: var(--black); color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; background: #000; }
        .card { background: var(--gray); padding: 25px; border-radius: 20px; border: 1px solid var(--gold); width: 100%; max-width: 380px; text-align: center; }
        
        .av-select { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .av-opt { width: 45px; height: 45px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .av-opt.active { border-color: var(--gold); transform: scale(1.1); box-shadow: 0 0 10px var(--gold); }
        
        input { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; border-radius: 10px; color: white; outline: none; text-align: center; }
        .btn { padding: 12px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: black; width: 100%; }

        header { padding: 10px; background: var(--gray); border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        #online-info { font-size: 10px; color: #4caf50; font-weight: bold; }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 15px; background: var(--gray); border-right: 3px solid var(--gold); align-self: flex-start; position: relative; }
        .my-msg { align-self: flex-end; border-right: none; border-left: 3px solid var(--gold); background: #333; }
        .msg-av { width: 28px; height: 28px; border-radius: 50%; vertical-align: middle; margin-left: 5px; border: 1px solid var(--gold); }

        .msg.is-deleted { opacity: 0.5; background: #111; }
        .deleted-text { font-style: italic; color: #777; font-size: 11px; }

        .input-bar { padding: 10px; background: var(--gray); display: flex; gap: 8px; align-items: center; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        #m { flex: 1; padding: 11px; border-radius: 20px; background: #222; border: 1px solid #444; color: white; text-align: right; }

        .reply-tag { font-size: 10px; color: var(--gold); background: rgba(255,255,255,0.05); padding: 3px; border-radius: 5px; margin-bottom: 5px; border-right: 2px solid var(--gold); }
        .del-link { color: #ff4444; cursor: pointer; font-size: 9px; margin-right: 8px; }
        .user-tag { color: var(--gold); font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="card">
            <h2 id="welcome-msg" style="color:var(--gold); margin-bottom: 5px;">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
            <div id="setup-fields">
                <p style="font-size:12px; color:#888;">Ø¢ÙˆØ§ØªØ§Ø± Ùˆ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
                <div class="av-select">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=1" class="av-opt active" onclick="selAv(this, '1')">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=2" class="av-opt" onclick="selAv(this, '2')">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=3" class="av-opt" onclick="selAv(this, '3')">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=4" class="av-opt" onclick="selAv(this, '4')">
                </div>
                <input type="text" id="u" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ Ø´Ù…Ø§">
            </div>
            <div id="login-fields">
                <input type="password" id="p" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
                <button class="btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØªØ§Ù„Ø§Ø±</button>
            </div>
        </div>
    </div>

    <div id="chat-page" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div id="online-info">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</div>
            <div style="display:flex; gap:10px;">
                <button onclick="showProfileChange()" style="background:none; border:1px solid var(--gold); color:var(--gold); border-radius:5px; font-size:9px; padding:3px 7px; cursor:pointer">ØªØºÛŒÛŒØ± Ù†Ø§Ù…</button>
                <button onclick="logout()" style="background:none; border:1px solid #ff4444; color:#ff4444; border-radius:5px; font-size:9px; padding:3px 7px; cursor:pointer">Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <div id="chat-area"></div>

        <div id="reply-info" style="display:none; background:#222; padding:5px 15px; font-size:11px; color:var(--gold); justify-content:space-between; align-items:center;">
            <span id="reply-to"></span> <b onclick="cancelReply()" style="cursor:pointer">âœ–</b>
        </div>

        <div class="input-bar">
            <button id="voice-btn" style="background:none; border:none; font-size:24px; cursor:pointer" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
            <input type="text" id="m" placeholder="Ú†ÛŒØ²ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off">
            <button class="btn" style="width:70px; padding:10px" onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let selectedAv = "1", replyTo = null, isTyping = false;
    let recorder, chunks = [], refreshInt, heartInt;

    // Ú†Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
    window.onload = () => {
        const savedU = localStorage.getItem('chat_u');
        const savedAv = localStorage.getItem('chat_av');
        if(savedU) {
            document.getElementById('setup-fields').style.display = 'none';
            document.getElementById('welcome-msg').innerText = "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØŒ " + savedU;
            selectedAv = savedAv || "1";
        }
    };

    function selAv(el, id) {
        document.querySelectorAll('.av-opt').forEach(i => i.classList.remove('active'));
        el.classList.add('active'); selectedAv = id;
    }

    function showProfileChange() {
        if(!confirm("Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø¨Ø§ÛŒØ¯ Ù…Ø¬Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ")) return;
        localStorage.removeItem('chat_u');
        location.reload();
    }

    async function login() {
        const uInput = document.getElementById('u').value.trim();
        const p = document.getElementById('p').value;
        const finalU = localStorage.getItem('chat_u') || uInput;

        if(!finalU || !p) return alert("Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");

        const res = await fetch(API, { method:'POST', body: JSON.stringify({type:'login', password:p}) });
        if((await res.json()).success) {
            localStorage.setItem('chat_u', finalU);
            localStorage.setItem('chat_p', p);
            localStorage.setItem('chat_av', selectedAv);
            startChat();
        } else alert("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
    }

    function startChat() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        heartInt = setInterval(() => {
            fetch(API, { method:'POST', body: JSON.stringify({
                type:'heartbeat', username: localStorage.getItem('chat_u'), av: localStorage.getItem('chat_av'), isTyping
            })});
        }, 8000);
        refreshInt = setInterval(refresh, 3000);
        refresh();
    }

    async function refresh() {
        try {
            const res = await fetch(API);
            const d = await res.json();
            const myU = localStorage.getItem('chat_u'), myP = localStorage.getItem('chat_p'), isAdmin = myP==='1111';

            document.getElementById('online-info').innerHTML = `ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†: ${d.onlineUsers.length} <span style="font-weight:normal; opacity:0.7">(${d.onlineUsers.map(u=>u.name).join(', ')})</span>`;

            const area = document.getElementById('chat-area');
            const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;

            area.innerHTML = d.messages.map(m => {
                if (m.isDeleted && !isAdmin) {
                    return `<div class="msg ${m.username === myU ? 'my-msg' : ''} is-deleted"><div class="deleted-text">ğŸš« Ù¾ÛŒØ§Ù… Ù¾Ø§Ú© Ø´Ø¯Ù‡</div></div>`;
                }
                return `
                <div class="msg ${m.username === myU ? 'my-msg' : ''} ${m.isDeleted ? 'is-deleted':''}" onclick="setReply('${m.username}')">
                    <img class="msg-av" src="https://api.dicebear.com/7.x/bottts/svg?seed=${m.av}">
                    <span class="user-tag">${m.username} ${m.isAdmin?'ğŸ‘‘':''}</span>
                    ${m.isDeleted && isAdmin ? '<br><small style="color:red">[Ø­Ø°Ù Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±]</small>' : ''}
                    ${m.replyTo ? `<div class="reply-tag">â†© Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡: ${m.replyTo}</div>` : ''}
                    <div style="margin-top:5px">${m.text}</div>
                    ${m.audio ? `<audio controls src="${m.audio}" style="width:160px; height:30px; filter:sepia(1); margin-top:5px;"></audio>` : ''}
                    <div style="font-size:8px; opacity:0.5; margin-top:5px; display:flex; justify-content:space-between">
                        <span>${m.time}</span>
                        ${(!m.isDeleted && (m.username === myU || isAdmin)) ? `<span onclick="del('${m.id}')" class="del-link">Ø­Ø°Ù</span>` : ''}
                    </div>
                </div>`;
            }).join('');
            if(isBottom) area.scrollTop = area.scrollHeight;
        } catch(e){}
    }

    async function send() {
        const inp = document.getElementById('m'); if(!inp.value.trim()) return;
        const txt = inp.value; inp.value = "";
        await post({ text: txt }); cancelReply();
    }

    async function post(data) {
        await fetch(API, { method:'POST', body: JSON.stringify({
            username: localStorage.getItem('chat_u'), 
            password: localStorage.getItem('chat_p'),
            av: localStorage.getItem('chat_av'),
            ...data, replyTo
        })});
        refresh();
    }

    function setReply(u) { replyTo = u; document.getElementById('reply-info').style.display='flex'; document.getElementById('reply-to').innerText="Ù¾Ø§Ø³Ø® Ø¨Ù‡: " + u; }
    function cancelReply() { replyTo = null; document.getElementById('reply-info').style.display='none'; }
    function logout() { if(confirm("Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ØŸ")){ clearInterval(refreshInt); clearInterval(heartInt); localStorage.clear(); location.reload(); } }

    async function startRec() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(s); chunks = [];
            document.getElementById('voice-btn').style.filter = "drop-shadow(0 0 5px red)";
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const b = new Blob(chunks, { type: 'audio/webm' });
                const r = new FileReader(); r.readAsDataURL(b);
                r.onloadend = () => post({ audio: r.result });
                document.getElementById('voice-btn').style.filter = "none";
            };
            recorder.start();
        } catch(e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†"); }
    }
    function stopRec() { if(recorder && recorder.state !== "inactive") recorder.stop(); }

    async function del(id) { 
        event.stopPropagation();
        if(!confirm("Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
        await fetch(API, { method:'DELETE', body: JSON.stringify({ messageId: id, password: localStorage.getItem('chat_p'), username: localStorage.getItem('chat_u') })});
        refresh(); 
    }

    document.getElementById('m').oninput = () => { isTyping=true; setTimeout(()=>isTyping=false, 2000); };
    document.getElementById('m').onkeypress = e => { if(e.key==='Enter') send(); };
    if(localStorage.getItem('chat_p')) startChat();
</script>
</body>
</html>
