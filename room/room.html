<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Together</title>

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:tahoma}
header{
  height:56px;
  background:#111;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 15px
}
main{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:calc(100vh - 56px)
}
video{
  width:100%;
  max-width:900px;
  background:#000
}
.login{
  max-width:320px;
  width:100%;
  padding:20px
}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  font-size:16px
}
button{background:#e50914;color:#fff}
.hidden{display:none}
.role{font-size:12px;color:#aaa}
.notice{font-size:13px;color:#f1c40f;margin-top:8px}
.back-btn{
  margin-top:10px;
  background:#333
}
</style>
</head>

<body>

<header>
  <div>ðŸŽ¬ Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ø¨Ø§Ù‡Ù…</div>
  <div id="userInfo"></div>
</header>

<!-- LOGIN -->
<div id="loginBox" class="login">
  <input id="nameInput" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§">
  <input id="passInput" type="password" placeholder="Ø±Ù…Ø² ÙˆØ±ÙˆØ¯">
  <button id="loginBtn">ÙˆØ±ÙˆØ¯</button>
</div>

<!-- PLAYER -->
<main id="playerBox" class="hidden">
  <video id="video" playsinline>
    <source src="https://s1.dlserfes.info/dl1/2018/Tag%202018/Tag_2018_720p_BrRip_YIFY.mp4?md5=JgOv4DHH-E856mk-iRe8Aw&u=288589&expires=1766897453" type="video/mp4">
  </video>

  <div id="notice" class="notice hidden">
    Ù…Ø§Ù„Ú© Ø¬Ù„Ø³Ù‡ Ø±Ø§ ØªØ±Ú© Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª
  </div>

  <button class="back-btn" onclick="goBack()">ðŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyCZVi8SyjtW6dxMHDX7D0lZEdF5XPLtwJA",
  authDomain: "softshiraz-2ddce.firebaseapp.com",
  databaseURL: "https://softshiraz-2ddce-default-rtdb.firebaseio.com/",
  projectId: "softshiraz-2ddce"
});
const db = firebase.database();

/* PASSWORDS */
const OWNER_PASS = "1111";
const VIEWER_PASS = "2222";

/* ELEMENTS */
const loginBox = document.getElementById("loginBox");
const playerBox = document.getElementById("playerBox");
const nameInput = document.getElementById("nameInput");
const passInput = document.getElementById("passInput");
const video = document.getElementById("video");
const notice = document.getElementById("notice");
const userInfo = document.getElementById("userInfo");

/* RESTORE NAME */
nameInput.value = localStorage.getItem("name") || "";

/* LOGIN */
loginBtn.onclick = () => {
  const name = nameInput.value.trim();
  const pass = passInput.value;
  if(!name) return alert("Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");

  localStorage.setItem("name", name);
  loginBox.classList.add("hidden");
  playerBox.classList.remove("hidden");

  if(pass === OWNER_PASS) enterOwner(name);
  else if(pass === VIEWER_PASS) enterViewer(name);
  else { alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡"); location.reload(); }
};

/* OWNER */
function enterOwner(name){
  userInfo.innerHTML = `${name} <span class="role">(Ù…Ø§Ù„Ú©)</span>`;
  video.controls = true;
  notice.classList.add("hidden");

  function sync(){
    db.ref("room").set({
      time: video.currentTime,
      playing: !video.paused,
      ownerLastSeen: Date.now()
    });
  }

  video.addEventListener("play", sync);
  video.addEventListener("pause", sync);
  video.addEventListener("seeked", sync);

  setInterval(()=>{
    if(!video.paused) sync();
  },2000);
}

/* VIEWER */
function enterViewer(name){
  userInfo.innerHTML = `${name} <span class="role">(Ø¨ÛŒÙ†Ù†Ø¯Ù‡)</span>`;
  video.controls = false;

  db.ref("room").on("value", snap=>{
    const d = snap.val();
    if(!d) return;

    const ownerOnline = Date.now() - d.ownerLastSeen < 5000;
    notice.classList.toggle("hidden", ownerOnline);

    if(Math.abs(video.currentTime - d.time) > 0.6)
      video.currentTime = d.time;

    d.playing ? video.play() : video.pause();
  });
}

/* BACK */
function goBack(){
  video.pause();
  playerBox.classList.add("hidden");
  loginBox.classList.remove("hidden");
  userInfo.innerHTML = "";
}
</script>

</body>
</html>