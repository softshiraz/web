<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± Ø·Ù„Ø§ÛŒÙ€ÛŒ | Voice & Online</title>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø«Ø§Ø¨Øª + Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ */
        :root { --gold: #d4af37; --black: #0f0f0f; --gray: #1e1e1e; }
        body { background: var(--black); color: white; font-family: Tahoma; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100%; }
        .login-card { background: var(--gray); padding: 30px; border-radius: 20px; border: 1px solid var(--gold); text-align: center; }
        
        #chat-page { display: none; flex-direction: column; height: 100%; }
        header { background: var(--gray); padding: 10px 20px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        
        #online-count { font-size: 11px; color: #4caf50; background: rgba(76, 175, 80, 0.1); padding: 2px 8px; border-radius: 10px; }
        #message-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg-bubble { max-width: 80%; padding: 10px; border-radius: 15px; background: #2a2a2a; align-self: flex-start; border-right: 3px solid var(--gold); }
        .my-bubble { align-self: flex-end; background: #3a3a3a; border-right: none; border-left: 3px solid var(--gold); }
        
        .input-bar { background: var(--gray); padding: 15px; display: flex; gap: 8px; align-items: center; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background: #222; color: white; outline: none; }
        
        .btn-gold { background: var(--gold); border: none; padding: 10px 15px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        #voice-btn { background: #444; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        #voice-btn.recording { background: #ff4444; animation: pulse 1s infinite; }
        
        audio { max-width: 100%; height: 35px; margin-top: 5px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="login-card">
            <h2 style="color: var(--gold)">ÙˆØ±ÙˆØ¯ ØªØ§Ù„Ø§Ø±</h2>
            <input type="text" id="uInp" placeholder="Ù†Ø§Ù…">
            <input type="password" id="pInp" placeholder="Ø±Ù…Ø²">
            <button class="btn-gold" style="width:100%; margin-top:10px" onclick="login()">ÙˆØ±ÙˆØ¯</button>
        </div>
    </div>

    <div id="chat-page">
        <header>
            <div>
                <b id="user-display" style="color:var(--gold)"></b>
                <div id="online-count">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>
            <button onclick="location.reload()" style="background:none; border:1px solid #ff4444; color:#ff4444; border-radius:5px; font-size:10px">Ø®Ø±ÙˆØ¬</button>
        </header>

        <div id="message-area"></div>

        <div class="input-bar">
            <button id="voice-btn" onmousedown="startRecord()" onmouseup="stopRecord()" ontouchstart="startRecord()" ontouchend="stopRecord()">ğŸ¤</button>
            <input type="text" id="mInp" placeholder="Ù¾ÛŒØ§Ù…..." autocomplete="off">
            <button class="btn-gold" onclick="sendText()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let mediaRecorder;
    let audioChunks = [];

    async function login() {
        const u = document.getElementById('uInp').value;
        const p = document.getElementById('pInp').value;
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'login', password: p }) });
        if(res.ok) {
            localStorage.setItem('chat_u', u);
            localStorage.setItem('chat_p', p);
            startChat();
        } else alert("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯");
    }

    function startChat() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        document.getElementById('user-display').innerText = localStorage.getItem('chat_u');
        
        setInterval(heartbeat, 5000);
        setInterval(refresh, 3000);
        refresh();
    }

    async function heartbeat() {
        fetch(API, { method: 'POST', body: JSON.stringify({ type: 'heartbeat', username: localStorage.getItem('chat_u') }) });
    }

    async function refresh() {
        const res = await fetch(API);
        const data = await res.json();
        
        document.getElementById('online-count').innerText = "Ø¢Ù†Ù„Ø§ÛŒÙ†: " + data.onlineUsers.length + " Ù†ÙØ± (" + data.onlineUsers.join(', ') + ")";
        
        const area = document.getElementById('message-area');
        const myU = localStorage.getItem('chat_u');
        const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;

        area.innerHTML = data.messages.map(m => `
            <div class="msg-bubble ${m.username === myU ? 'my-bubble' : ''}">
                <small style="color:var(--gold)">${m.username}</small>
                <div>${m.text}</div>
                ${m.audio ? `<audio controls src="${m.audio}"></audio>` : ''}
                <div style="font-size:8px; color:#888; margin-top:5px">${m.time}</div>
            </div>
        `).join('');

        if(isBottom) area.scrollTop = area.scrollHeight;
    }

    async function sendText() {
        const inp = document.getElementById('mInp');
        if(!inp.value) return;
        await postData({ text: inp.value });
        inp.value = "";
    }

    async function postData(obj) {
        await fetch(API, {
            method: 'POST',
            body: JSON.stringify({
                username: localStorage.getItem('chat_u'),
                password: localStorage.getItem('chat_p'),
                ...obj
            })
        });
        refresh();
    }

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¶Ø¨Ø· ØµØ¯Ø§ ---
    async function startRecord() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        document.getElementById('voice-btn').classList.add('recording');
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => postData({ audio: reader.result });
        };
        mediaRecorder.start();
    }

    function stopRecord() {
        if(mediaRecorder) {
            mediaRecorder.stop();
            document.getElementById('voice-btn').classList.remove('recording');
        }
    }

    if(localStorage.getItem('chat_u')) startChat();
</script>
</body>
</html>
