<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± VIP | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <style>
        :root { --gold: #d4af37; --black: #0d0d0d; --gray: #1a1a1a; }
        * { box-sizing: border-box; font-family: Tahoma, sans-serif; }
        body { background: var(--black); color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; background: #000; }
        .card { background: var(--gray); padding: 30px; border-radius: 20px; border: 1px solid var(--gold); width: 100%; max-width: 350px; text-align: center; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; border-radius: 10px; color: white; outline: none; }
        .btn { padding: 12px 20px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: black; }

        header { padding: 10px 15px; background: var(--gray); border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        #online-list { font-size: 11px; color: #4caf50; }

        #pin-bar { background: rgba(212, 175, 55, 0.15); border-bottom: 1px dashed var(--gold); padding: 8px 15px; display: none; align-items: center; gap: 10px; color: var(--gold); font-size: 13px; }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 10px 15px; border-radius: 18px; background: var(--gray); border-right: 3px solid var(--gold); align-self: flex-start; }
        .my-msg { align-self: flex-end; background: #333; border-right: none; border-left: 3px solid var(--gold); }
        .msg b { color: var(--gold); font-size: 11px; display: block; }
        .ops { font-size: 9px; margin-top: 6px; display: flex; gap: 10px; opacity: 0.6; }

        .input-bar { padding: 15px; background: var(--gray); display: flex; gap: 8px; align-items: center; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        #voice-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #333; color: white; cursor: pointer; font-size: 20px; }
        #voice-btn.recording { background: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        audio { height: 30px; width: 180px; filter: sepia(1); margin-top: 5px; }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="card">
            <h2 style="color:var(--gold)">ÙˆØ±ÙˆØ¯ ØªÙ€Ø§Ù„Ø§Ø±</h2>
            <input type="text" id="u" placeholder="Ù†Ø§Ù…">
            <input type="password" id="p" placeholder="Ø±Ù…Ø²">
            <button class="btn" style="width:100%" onclick="login()">ÙˆØ±ÙˆØ¯</button>
        </div>
    </div>

    <div id="chat-page" style="display:none; flex-direction:column; height:100%;">
        <header>
            <div id="online-list">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>
            <button onclick="logout()" style="background:none; border:1px solid #ff4444; color:#ff4444; border-radius:5px; font-size:10px; padding:4px 10px; cursor:pointer">Ø®Ø±ÙˆØ¬</button>
        </header>

        <div id="pin-bar">
            <span>ğŸ“Œ</span>
            <marquee id="pin-text" style="flex:1"></marquee>
            <b id="unpin-btn" onclick="unpin()" style="cursor:pointer; display:none">âœ–</b>
        </div>

        <div id="chat-area"></div>

        <div class="input-bar">
            <button id="voice-btn" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
            <input type="text" id="m" placeholder="Ù¾ÛŒØ§Ù…..." autocomplete="off">
            <button class="btn" onclick="sendText()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let recorder, chunks = [], refreshInterval, heartInterval;

    async function login() {
        const u = document.getElementById('u').value.trim(), p = document.getElementById('p').value.trim();
        if(!u || !p) return alert("ÙÛŒÙ„Ø¯Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
        
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'login', password: p }) });
        const data = await res.json();
        
        if(data.success) {
            localStorage.setItem('chat_u', u);
            localStorage.setItem('chat_p', p);
            startChat();
        } else { alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"); }
    }

    function startChat() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        
        // ØªÙ†Ø¸ÛŒÙ… Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒâ€ŒØ¯ÛŒ Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯Ø± Ø®Ø±ÙˆØ¬
        heartInterval = setInterval(() => {
            fetch(API, { method: 'POST', body: JSON.stringify({ type: 'heartbeat', username: localStorage.getItem('chat_u') }) });
        }, 8000);
        
        refreshInterval = setInterval(refresh, 3000);
        refresh();
    }

    async function refresh() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            const myU = localStorage.getItem('chat_u'), myP = localStorage.getItem('chat_p'), isAdmin = myP === '1111';
            
            document.getElementById('online-list').innerText = "ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†: " + data.onlineUsers.length + " Ù†ÙØ± (" + data.onlineUsers.join(', ') + ")";
            
            if(data.pinned) {
                document.getElementById('pin-bar').style.display = 'flex';
                document.getElementById('pin-text').innerText = data.pinned.username + ": " + (data.pinned.text || "Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ");
                document.getElementById('unpin-btn').style.display = isAdmin ? 'block' : 'none';
            } else { document.getElementById('pin-bar').style.display = 'none'; }

            const area = document.getElementById('chat-area');
            const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;

            area.innerHTML = data.messages.map(m => `
                <div class="msg ${m.username === myU ? 'my-msg' : ''}">
                    <b>${m.username} ${m.isAdmin ? 'ğŸ‘‘' : ''}</b>
                    <div>${m.text}</div>
                    ${m.audio ? `<audio controls src="${m.audio}"></audio>` : ''}
                    <div class="ops">
                        <span>${m.time}</span>
                        ${isAdmin ? `<span onclick="pin('${m.id}')" style="color:var(--gold);cursor:pointer">ğŸ“Œ Ù¾ÛŒÙ†</span>` : ''}
                        ${isAdmin ? `<span onclick="del('${m.id}')" style="color:#ff4444;cursor:pointer">Ø­Ø°Ù</span>` : ''}
                    </div>
                </div>
            `).join('');

            if(isBottom) area.scrollTop = area.scrollHeight;
        } catch(e) {}
    }

    async function sendText() {
        const inp = document.getElementById('m'); if(!inp.value.trim()) return;
        const t = inp.value; inp.value = "";
        await post({ text: t });
    }

    async function post(d) {
        await fetch(API, { method: 'POST', body: JSON.stringify({ username: localStorage.getItem('chat_u'), password: localStorage.getItem('chat_p'), ...d }) });
        refresh();
    }

    // Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª
    async function pin(id) {
        const res = await fetch(API); const d = await res.json();
        const msg = d.messages.find(m => m.id === id);
        await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'pin', password: localStorage.getItem('chat_p'), msgData: msg }) });
        refresh();
    }
    async function unpin() {
        await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'unpin', password: localStorage.getItem('chat_p') }) });
        refresh();
    }
    async function del(id) {
        if(!confirm("Ø­Ø°Ù Ù¾ÛŒØ§Ù…ØŸ")) return;
        await fetch(API, { method: 'DELETE', body: JSON.stringify({ messageId: id, adminPassword: localStorage.getItem('chat_p') }) });
        refresh();
    }

    // Ø¶Ø¨Ø· ÙˆÛŒØ³
    async function startRec() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(s); chunks = [];
            document.getElementById('voice-btn').classList.add('recording');
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const b = new Blob(chunks, { type: 'audio/webm' });
                const r = new FileReader(); r.readAsDataURL(b);
                r.onloadend = () => post({ audio: r.result });
            };
            recorder.start();
        } catch(e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†"); }
    }
    function stopRec() { if(recorder && recorder.state !== "inactive") { recorder.stop(); document.getElementById('voice-btn').classList.remove('recording'); } }

    // ØªØ§Ø¨Ø¹ Ø®Ø±ÙˆØ¬ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
    function logout() {
        if(!confirm("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ")) return;
        // Û±. ØªÙˆÙ‚Ù ØªÙ…Ø§Ù… Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„â€ŒÙ‡Ø§
        clearInterval(refreshInterval);
        clearInterval(heartInterval);
        // Û². Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø±
        localStorage.clear();
        // Û³. Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ùˆ Ù†ÙˆØ³Ø§Ø²ÛŒ ØµÙØ­Ù‡
        window.location.reload();
    }

    document.getElementById('m').onkeypress = e => { if(e.key==='Enter') sendText(); };
    if(localStorage.getItem('chat_u')) startChat();
</script>
</body>
</html>
