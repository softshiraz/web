<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± Ù…Ø¬Ù„Ø³ÛŒ | Ø·Ù„Ø§ÛŒÛŒ</title>
    <style>
        :root { --gold: #d4af37; --black: #0a0a0a; --gray: #1a1a1a; --white: #ffffff; }
        * { box-sizing: border-box; font-family: Tahoma, sans-serif; }
        body { background: var(--black); color: var(--white); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Ù„Ø§Ú¯ÛŒÙ† */
        #auth-page { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; }
        .card { background: var(--gray); padding: 30px; border-radius: 20px; border: 1px solid var(--gold); width: 100%; max-width: 350px; text-align: center; box-shadow: 0 0 20px rgba(212,175,55,0.2); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; border-radius: 10px; color: white; outline: none; }
        input:focus { border-color: var(--gold); }
        .btn { width: 100%; padding: 12px; background: var(--gold); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: black; }

        /* ØªØ§Ù„Ø§Ø± Ú†Øª */
        #chat-page { display: none; flex-direction: column; height: 100%; }
        header { padding: 10px 20px; background: var(--gray); border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        #online-bar { font-size: 11px; color: #4caf50; }

        #msg-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); }
        .msg { max-width: 85%; padding: 10px 15px; border-radius: 18px; position: relative; background: var(--gray); border-right: 3px solid var(--gold); align-self: flex-start; }
        .my-msg { align-self: flex-end; background: #333; border-right: none; border-left: 3px solid var(--gold); }
        .msg b { color: var(--gold); font-size: 12px; }
        .time { font-size: 9px; color: #888; display: flex; justify-content: space-between; margin-top: 5px; }

        .input-area { padding: 15px; background: var(--gray); display: flex; gap: 10px; align-items: center; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        #voice-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #333; color: white; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        #voice-btn.recording { background: #ff4444; animation: pulse 1s infinite; }
        
        audio { height: 30px; width: 200px; margin-top: 5px; filter: sepia(100%) saturate(200%) hue-rotate(10deg); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="card">
            <h2 style="color:var(--gold)">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØªØ§Ù„Ø§Ø±</h2>
            <input type="text" id="u" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ">
            <input type="password" id="p" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <button class="btn" onclick="login()">ÙˆØ±ÙˆØ¯ Ø§Ø´Ø±Ø§ÙÛŒ</button>
        </div>
    </div>

    <div id="chat-page">
        <header>
            <div>
                <div id="online-bar">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</div>
                <small id="me-display" style="color:var(--gold)"></small>
            </div>
            <button onclick="location.reload()" style="background:none; border:1px solid #ff4444; color:#ff4444; border-radius:5px; padding:2px 8px; font-size:10px">Ø®Ø±ÙˆØ¬</button>
        </header>

        <div id="msg-container"></div>

        <div class="input-area">
            <button id="voice-btn" onmousedown="startRecord()" onmouseup="stopRecord()" ontouchstart="startRecord()" ontouchend="stopRecord()">ğŸ¤</button>
            <input type="text" id="m" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off">
            <button class="btn" style="width:80px" onclick="sendText()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let recorder;
    let chunks = [];

    async function login() {
        const u = document.getElementById('u').value.trim();
        const p = document.getElementById('p').value.trim();
        if(!u || !p) return;

        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'login', password: p }) });
        if(res.ok) {
            localStorage.setItem('chat_u', u);
            localStorage.setItem('chat_p', p);
            init();
        } else alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
    }

    function init() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        document.getElementById('me-display').innerText = "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ " + localStorage.getItem('chat_u');
        
        setInterval(heartbeat, 7000);
        setInterval(refresh, 3000);
        refresh();
    }

    async function heartbeat() {
        fetch(API, { method: 'POST', body: JSON.stringify({ type: 'heartbeat', username: localStorage.getItem('chat_u') }) });
    }

    async function refresh() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            
            document.getElementById('online-bar').innerText = "ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†: " + data.onlineUsers.length + " Ù†ÙØ± (" + data.onlineUsers.join(', ') + ")";
            
            const area = document.getElementById('msg-container');
            const myU = localStorage.getItem('chat_u');
            const myP = localStorage.getItem('chat_p');
            const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;

            area.innerHTML = data.messages.map(m => `
                <div class="msg ${m.username === myU ? 'my-msg' : ''}">
                    <b>${m.username} ${m.isAdmin ? 'ğŸ‘‘' : ''}</b>
                    <div>${m.text}</div>
                    ${m.audio ? `<audio controls src="${m.audio}"></audio>` : ''}
                    <div class="time">
                        ${m.time}
                        ${myP === '1111' ? `<span style="color:#ff4444;cursor:pointer" onclick="del('${m.id}')">Ø­Ø°Ù</span>` : ''}
                    </div>
                </div>
            `).join('');

            if(isBottom) area.scrollTop = area.scrollHeight;
        } catch(e) {}
    }

    async function sendText() {
        const inp = document.getElementById('m');
        if(!inp.value.trim()) return;
        const txt = inp.value;
        inp.value = "";
        await post({ text: txt });
    }

    async function post(data) {
        await fetch(API, {
            method: 'POST',
            body: JSON.stringify({
                username: localStorage.getItem('chat_u'),
                password: localStorage.getItem('chat_p'),
                ...data
            })
        });
        refresh();
    }

    async function del(id) {
        if(!confirm("Ø­Ø°ÙØŸ")) return;
        await fetch(API, {
            method: 'DELETE',
            body: JSON.stringify({ messageId: id, adminPassword: localStorage.getItem('chat_p') })
        });
        refresh();
    }

    // Ø¶Ø¨Ø· ØµØ¯Ø§
    async function startRecord() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            chunks = [];
            document.getElementById('voice-btn').classList.add('recording');
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => post({ audio: reader.result });
            };
            recorder.start();
        } catch(e) { alert("Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯"); }
    }

    function stopRecord() {
        if(recorder && recorder.state !== "inactive") {
            recorder.stop();
            document.getElementById('voice-btn').classList.remove('recording');
        }
    }

    document.getElementById('m').onkeypress = e => { if(e.key==='Enter') sendText(); };
    if(localStorage.getItem('chat_u')) init();
</script>
</body>
</html>
