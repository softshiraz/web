<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Together - Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
<style>
body{margin:0;font-family:tahoma;background:#0b0b0b;color:#fff}
header{height:56px;background:#111;display:flex;align-items:center;justify-content:space-between;padding:0 15px}
main{display:flex;flex-direction:column;align-items:center;justify-content:center;height:calc(100vh - 56px)}
video{width:100%;max-width:900px;background:#000}
.login{max-width:320px;width:100%;padding:20px;position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);backdrop-filter:blur(10px)}
.login input, .login button{width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px;font-size:16px}
.login button{background:#e50914;color:#fff;cursor:pointer}
.hidden{display:none}
.role{font-size:12px;color:#aaa}
.notice{font-size:13px;color:#f1c40f;margin-top:8px}
.back-btn{margin-top:10px;background:#333;color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer}
</style>
</head>
<body>

<!-- ÙˆØ±ÙˆØ¯ -->
<div class="login" id="loginBox">
  <div style="width:100%">
    <input type="text" id="nameInput" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <input type="password" id="passInput" placeholder="Ø±Ù…Ø² ÙˆØ±ÙˆØ¯">
    <button onclick="login('owner')">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ù„Ú©</button>
    <button onclick="login('user')">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ø±Ø¨Ø±</button>
    <p id="errorMsg" style="color:#ff6b6b;margin-top:10px"></p>
  </div>
</div>

<!-- Ù¾Ù„ÛŒØ± -->
<main id="playerBox" class="hidden">
  <header>
    <div id="userInfo"></div>
    <button class="back-btn" onclick="goBack()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
  </header>
  <video id="videoPlayer" playsinline></video>
  <div id="notice" class="notice hidden">Ù…Ø§Ù„Ú© Ø¬Ù„Ø³Ù‡ Ø±Ø§ ØªØ±Ú© Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª</div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ğŸ”¥ Firebase
firebase.initializeApp({
  apiKey: "AIzaSyCZVi8SyjtW6dxMHDX7D0lZEdF5XPLtwJA",
  authDomain: "softshiraz-2ddce.firebaseapp.com",
  databaseURL: "https://softshiraz-2ddce-default-rtdb.firebaseio.com/",
  projectId: "softshiraz-2ddce"
});
const db = firebase.database();

// ğŸ”‘ Ø±Ù…Ø²Ù‡Ø§
const OWNER_PASS = "1111";
const USER_PASS = "2222";

// Ù„ÛŒÙ†Ú© ÙÛŒÙ„Ù…
const VIDEO_URL = "https://s1.dlserfes.info/dl1/2018/Tag%202018/Tag_2018_720p_BrRip_YIFY.mp4?md5=JgOv4DHH-E856mk-iRe8Aw&u=288589&expires=1766897453";

// Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§
const loginBox = document.getElementById("loginBox");
const playerBox = document.getElementById("playerBox");
const nameInput = document.getElementById("nameInput");
const passInput = document.getElementById("passInput");
const errorMsg = document.getElementById("errorMsg");
const video = document.getElementById("videoPlayer");
const userInfo = document.getElementById("userInfo");
const notice = document.getElementById("notice");

let isOwner = false;
let userName = "";

// âœ… ÙˆØ±ÙˆØ¯
function login(role){
  const name = nameInput.value.trim();
  const pass = passInput.value;
  errorMsg.textContent = "";

  if(!name){ errorMsg.textContent = "Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"; return; }
  if(role==="owner" && pass!==OWNER_PASS){ errorMsg.textContent="Ø±Ù…Ø² Ù…Ø§Ù„Ú© Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"; return; }
  if(role==="user" && pass!==USER_PASS){ errorMsg.textContent="Ø±Ù…Ø² Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"; return; }

  userName = name;
  isOwner = (role==="owner");

  loginBox.classList.add("hidden");
  playerBox.classList.remove("hidden");

  userInfo.textContent = `${userName} (${isOwner?"Ù…Ø§Ù„Ú©":"Ú©Ø§Ø±Ø¨Ø±"})`;

  initVideoSync();
}

// ğŸ”„ Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ÙˆØ±ÙˆØ¯
function goBack(){
  video.pause();
  playerBox.classList.add("hidden");
  loginBox.classList.remove("hidden");
}

// ğŸ”— Ø³ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ
function initVideoSync(){
  video.src = VIDEO_URL;
  video.load();
  let isSeeking=false;
  const videoRef = db.ref("watchroom/video");

  // Ù…Ø§Ù„Ú© Ú©Ù†ØªØ±Ù„
  video.addEventListener("play",()=>{ if(isOwner && !isSeeking) videoRef.update({playing:true,currentTime:video.currentTime,lastSeen:Date.now()}); });
  video.addEventListener("pause",()=>{ if(isOwner && !isSeeking) videoRef.update({playing:false,currentTime:video.currentTime,lastSeen:Date.now()}); });
  video.addEventListener("seeking",()=>{ isSeeking=true; });
  video.addEventListener("seeked",()=>{ if(isOwner) videoRef.update({currentTime:video.currentTime,lastSeen:Date.now()}); isSeeking=false; });

  // Ø¨ÛŒÙ†Ù†Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª
  videoRef.on("value",snap=>{
    const state = snap.val();
    if(!state) return;

    const ownerOnline = Date.now()-state.lastSeen<5000;
    notice.classList.toggle("hidden",ownerOnline);

    if(Math.abs(video.currentTime-state.currentTime)>0.5)
      video.currentTime=state.currentTime;

    state.playing?video.play().catch(()=>{}):video.pause();
  });

  // Ù¾Ø®Ø´ Ø§ÙˆÙ„ÛŒÙ‡
  videoRef.once("value").then(snap=>{
    const state = snap.val();
    if(state && state.playing){
      video.currentTime=state.currentTime||0;
      video.play().catch(()=>{});
    }
  });

  // heartbeat Ù…Ø§Ù„Ú©
  if(isOwner){
    setInterval(()=>{
      videoRef.update({lastSeen:Date.now(),currentTime:video.currentTime});
    },2000);
  }
}
</script>
</body>
</html>