<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>اتاق پخش فیلم - واچ پارتی</title>
  <style>
    body { 
      margin:0; 
      padding:0; 
      font-family: Tahoma, sans-serif; 
      background:#000; 
      color:#eee; 
      height:100vh; 
      overflow:hidden; 
    }
    header { 
      position:fixed; 
      top:0; left:0; right:0; 
      background:rgba(0,0,0,0.7); 
      backdrop-filter:blur(8px); 
      padding:10px 15px; 
      z-index:100; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      border-bottom:1px solid rgba(255,255,255,0.1); 
    }
    .logo-link { 
      color:#4da6ff; 
      text-decoration:none; 
      font-weight:bold; 
      font-size:1.1em; 
    }
    .user-info { 
      font-size:0.85em; 
      display:flex; 
      align-items:center; 
      gap:10px; 
    }
    #changeNameBtn, #ownerPassBtn {
      background:#4da6ff; 
      color:white; 
      border:none; 
      padding:5px 10px; 
      border-radius:6px; 
      cursor:pointer; 
      font-size:0.8em; 
    }
    #ownerPassBtn { background:#e74c3c; }
    #ownerPassBtn:hover { background:#c0392b; }
    #changeNameBtn:hover { background:#3b8ed9; }

    .container { 
      height:100vh; 
      display:flex; 
      flex-direction:column; 
    }
    .video-section { 
      flex:1; 
      position:relative; 
      background:#000; 
    }
    #video-player { 
      width:100%; 
      height:100%; 
      object-fit:contain; 
    }
    .chat-overlay { 
      position:absolute; 
      bottom:0; left:0; right:0; 
      height:35%; 
      background:rgba(0,0,0,0.6); 
      backdrop-filter:blur(10px); 
      border-top:1px solid rgba(255,255,255,0.1); 
      display:flex; 
      flex-direction:column; 
      z-index:50; 
    }
    #messages { 
      flex:1; 
      padding:15px; 
      overflow-y:auto; 
      font-size:0.95em; 
    }
    .message { 
      margin:8px 0; 
      padding:8px 12px; 
      border-radius:12px; 
      max-width:80%; 
      word-wrap:break-word; 
    }
    .message.self { 
      background:#4da6ff; 
      margin-left:auto; 
    }
    .message.other { 
      background:rgba(255,255,255,0.15); 
    }
    .username { 
      font-weight:bold; 
      font-size:0.85em; 
      display:block; 
      margin-bottom:3px; 
      color:#a0d8ff; 
    }
    #chat-form { 
      display:flex; 
      padding:10px 15px; 
      border-top:1px solid rgba(255,255,255,0.1); 
    }
    #message-input { 
      flex:1; 
      padding:10px 15px; 
      border:none; 
      border-radius:20px 0 0 20px; 
      background:rgba(255,255,255,0.1); 
      color:white; 
    }
    button[type="submit"] { 
      padding:10px 20px; 
      border:none; 
      background:#4da6ff; 
      color:white; 
      border-radius:0 20px 20px 0; 
      cursor:pointer; 
    }
    button[type="submit"]:hover { background:#3b8ed9; }

    .status { 
      position:absolute; 
      top:10px; left:50%; 
      transform:translateX(-50%); 
      background:rgba(0,0,0,0.7); 
      padding:6px 12px; 
      border-radius:8px; 
      font-size:0.8em; 
      z-index:60; 
    }

    .overlay { 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,0.9); 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      z-index:200; 
    }
    .overlay-content { 
      background:#222; 
      padding:30px; 
      border-radius:12px; 
      width:90%; max-width:360px; 
      text-align:center; 
    }
    .overlay-content input { 
      width:100%; padding:12px; margin:10px 0; 
      border:none; border-radius:8px; background:#333; color:white; 
    }
    .overlay-content button { 
      width:100%; padding:12px; margin-top:10px; 
      background:#4da6ff; color:white; border:none; border-radius:8px; cursor:pointer; 
    }
    .error { color:#ff6b6b; margin-top:10px; font-size:0.9em; }
  </style>
</head>
<body>

<header>
  <a href="../index.html" class="logo-link">← بازگشت</a>
  <div class="user-info">
    <span id="displayName">...</span>
    <button id="changeNameBtn">تغییر نام</button>
    <button id="ownerPassBtn">تنظیم رمز مالک</button>
  </div>
</header>

<div class="container">
  <div class="video-section">
    <video id="video-player" controls></video>
    <div class="status">در حال سینک با دیگران...</div>

    <!-- چت شفاف روی ویدیو -->
    <div class="chat-overlay">
      <div id="messages"></div>
      <form id="chat-form">
        <input type="text" id="message-input" placeholder="پیام بنویس..." autocomplete="off" required />
        <button type="submit">ارسال</button>
      </form>
    </div>
  </div>
</div>

<!-- فرم انتخاب نام -->
<div class="overlay" id="nameOverlay">
  <div class="overlay-content">
    <h2>انتخاب نام نمایشی</h2>
    <input type="text" id="usernameInput" placeholder="نام خود را وارد کنید" required />
    <button onclick="saveName()">تأیید</button>
    <p class="error" id="nameError"></p>
  </div>
</div>

<!-- فرم رمز مالک (فقط یک بار) -->
<div class="overlay" id="ownerPassOverlay" style="display:none;">
  <div class="overlay-content">
    <h2>تنظیم رمز مالک</h2>
    <p style="font-size:0.9em; color:#aaa; margin-bottom:15px;">رمز پیش‌فرض: <strong>0000</strong></p>
    <input type="password" id="ownerPasswordInput" placeholder="رمز مالک" required />
    <button onclick="setOwnerPassword()">ذخیره رمز</button>
    <p class="error" id="passError"></p>
  </div>
</div>

<!-- فرم ورود رمز کاربر -->
<div class="overlay" id="userPassOverlay">
  <div class="overlay-content">
    <h2>ورود به اتاق</h2>
    <p style="font-size:0.9em; color:#aaa; margin-bottom:15px;">رمز کاربر: <strong>1234</strong></p>
    <input type="password" id="userPasswordInput" placeholder="رمز کاربر (1234)" required />
    <button onclick="checkUserPassword()">ورود</button>
    <p class="error" id="userPassError"></p>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCZVi8SyjtW6dxMHDX7D0lZEdF5XPLtwJA",
  authDomain: "softshiraz-2ddce.firebaseapp.com",
  databaseURL: "https://softshiraz-2ddce-default-rtdb.firebaseio.com/",
  projectId: "softshiraz-2ddce",
  storageBucket: "softshiraz-2ddce.firebasestorage.app",
  messagingSenderId: "760975223534",
  appId: "1:760975223534:web:3008a1fbcc09a2ae2fe1ff",
  measurementId: "G-MRLRFEVB3D"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// مراجع دیتابیس
const videoStateRef = db.ref('watchparty/videoState');
const messagesRef = db.ref('watchparty/messages').limitToLast(300);
const ownerPassRef = db.ref('watchparty/ownerPass');

// متغیرهای محلی
let currentUser = { uid: null, displayName: null };
let isOwner = false;

// رمزهای پیش‌فرض
const DEFAULT_OWNER_PASS = "0000";
const DEFAULT_USER_PASS = "1234";

// چک کردن رمز کاربر برای ورود به صفحه
function checkUserPassword() {
  const inputPass = document.getElementById('userPasswordInput').value.trim();
  if (inputPass === DEFAULT_USER_PASS) {
    document.getElementById('userPassOverlay').style.display = 'none';
    document.getElementById('userPassError').textContent = '';
    // حالا کاربر وارد شده، ادامه بده
    if (getOrCreateUser()) {
      initVideoSync();
      loadMessages();
    }
  } else {
    document.getElementById('userPassError').textContent = 'رمز اشتباه است!';
  }
}

// گرفتن UID و نام از localStorage
function getOrCreateUser() {
  let uid = localStorage.getItem('watchparty_uid');
  let name = localStorage.getItem('watchparty_name');
  let ownerPass = localStorage.getItem('watchparty_ownerPass');

  if (!uid) {
    uid = 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('watchparty_uid', uid);
  }

  if (!name) {
    showNamePrompt();
    return false;
  }

  currentUser = { uid, displayName: name };
  document.getElementById('displayName').textContent = name;
  document.getElementById('changeNameBtn').style.display = 'inline';

  // چک کردن مالک بودن
  if (ownerPass) {
    ownerPassRef.once('value').then(snap => {
      if (snap.val() === ownerPass) {
        isOwner = true;
        document.getElementById('ownerPassBtn').textContent = 'مالک هستید';
        document.getElementById('ownerPassBtn').disabled = true;
        document.getElementById('ownerPassBtn').style.background = '#27ae60';
      }
    });
  }

  return true;
}

// نمایش فرم نام
function showNamePrompt() {
  document.getElementById('nameOverlay').style.display = 'flex';
}

// ذخیره نام
function saveName() {
  const name = document.getElementById('usernameInput').value.trim();
  if (name.length < 2 || name.length > 20) {
    document.getElementById('nameError').textContent = 'نام باید ۲ تا ۲۰ کاراکتر باشد';
    return;
  }
  localStorage.setItem('watchparty_name', name);
  currentUser.displayName = name;
  document.getElementById('displayName').textContent = name;
  document.getElementById('changeNameBtn').style.display = 'inline';
  document.getElementById('nameOverlay').style.display = 'none';
  document.getElementById('nameError').textContent = '';

  initVideoSync();
  loadMessages();
}

// تنظیم رمز مالک
document.getElementById('ownerPassBtn').onclick = function() {
  document.getElementById('ownerPassOverlay').style.display = 'flex';
};

function setOwnerPassword() {
  const pass = document.getElementById('ownerPasswordInput').value.trim();
  if (pass.length < 4) {
    document.getElementById('passError').textContent = 'رمز باید حداقل ۴ کاراکتر باشد';
    return;
  }

  ownerPassRef.set(pass).then(() => {
    localStorage.setItem('watchparty_ownerPass', pass);
    isOwner = true;
    document.getElementById('ownerPassBtn').textContent = 'مالک هستید';
    document.getElementById('ownerPassBtn').disabled = true;
    document.getElementById('ownerPassBtn').style.background = '#27ae60';
    document.getElementById('ownerPassOverlay').style.display = 'none';
  }).catch(err => {
    document.getElementById('passError').textContent = 'خطا در ذخیره رمز';
  });
}

// سینک ویدیو (فقط مالک می‌تواند کنترل کند)
let isUserSeeking = false;

function initVideoSync() {
  const video = document.getElementById('video-player');
  const VIDEO_URL = "https://s1.dlserfes.info/dl1/2018/Tag%202018/Tag_2018_720p_BrRip_YIFY.mkv?md5=JgOv4DHH-E856mk-iRe8Aw&u=288589&expires=1766897453";

  video.src = VIDEO_URL;
  video.load();

  video.addEventListener('play', () => { 
    if (isOwner && !isUserSeeking) videoStateRef.update({ playing: true }); 
  });
  video.addEventListener('pause', () => { 
    if (isOwner && !isUserSeeking) videoStateRef.update({ playing: false }); 
  });
  video.addEventListener('seeking', () => { isUserSeeking = true; });
  video.addEventListener('seeked', () => {
    if (isOwner) {
      videoStateRef.update({ currentTime: video.currentTime });
    }
    isUserSeeking = false;
  });

  videoStateRef.on('value', snapshot => {
    const state = snapshot.val();
    if (!state) return;
    if (state.playing && video.paused) video.play().catch(()=>{});
    if (!state.playing && !video.paused) video.pause();
    if (Math.abs(video.currentTime - state.currentTime) > 2) {
      video.currentTime = state.currentTime;
    }
  });

  video.play().catch(() => {});
}

// چت
function loadMessages() {
  messagesRef.on('child_added', snapshot => {
    const msg = snapshot.val();
    const div = document.createElement('div');
    div.className = `message ${msg.uid === currentUser.uid ? 'self' : 'other'}`;
    div.innerHTML = `<span class="username">${msg.displayName}</span>${msg.text}`;
    document.getElementById('messages').appendChild(div);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  });
}

document.getElementById('chat-form').addEventListener('submit', e => {
  e.preventDefault();
  const text = document.getElementById('message-input').value.trim();
  if (text && currentUser.displayName) {
    messagesRef.push({
      text: text,
      displayName: currentUser.displayName,
      uid: currentUser.uid,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    document.getElementById('message-input').value = '';
  }
});

// تغییر نام
document.getElementById('changeNameBtn').addEventListener('click', () => {
  document.getElementById('usernameInput').value = currentUser.displayName;
  document.getElementById('nameOverlay').style.display = 'flex';
});

// شروع برنامه: اول رمز کاربر رو چک کن
checkUserPassword();
</script>
</body>
</html>