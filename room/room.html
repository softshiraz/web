<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>واچ پارتی - فیلم تگ (۲۰۱۸)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #e0e0ff;
      height: 100vh;
      overflow: hidden;
      background-attachment: fixed;
    }

    /* فرم ورود اصلی - جذاب و مدرن */
    .login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      z-index: 1000;
    }
    .login-card {
      background: rgba(30, 30, 60, 0.85);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 40px 35px;
      width: 90%;
      max-width: 420px;
      border: 1px solid rgba(100, 100, 255, 0.2);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .login-title {
      font-size: 2em;
      margin-bottom: 30px;
      text-align: center;
      color: #a0c4ff;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .input-group {
      margin-bottom: 20px;
      position: relative;
    }
    .input-group input {
      width: 100%;
      padding: 14px 18px;
      border: none;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      color: white;
      font-size: 1.05em;
      transition: all 0.3s;
    }
    .input-group input:focus {
      outline: none;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 3px rgba(100, 150, 255, 0.4);
    }
    .input-group label {
      position: absolute;
      top: 50%;
      right: 18px;
      transform: translateY(-50%);
      color: #aaa;
      pointer-events: none;
      transition: all 0.3s;
    }
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -10px;
      right: 18px;
      font-size: 0.85em;
      background: rgba(30,30,60,0.85);
      padding: 0 8px;
      color: #a0c4ff;
    }
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    .btn-owner {
      background: linear-gradient(90deg, #ff6b6b, #ff8e53);
      color: white;
    }
    .btn-user {
      background: linear-gradient(90deg, #4da6ff, #6b8cff);
      color: white;
    }
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.4);
    }
    .error-msg {
      color: #ff6b6b;
      text-align: center;
      margin-top: 15px;
      font-size: 0.95em;
    }

    /* صفحه اصلی */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: rgba(10,10,30,0.8);
      backdrop-filter: blur(12px);
      padding: 12px 20px;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .logo-link {
      color: #a0c4ff;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.2em;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.9em;
    }
    .role-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
    }
    .owner-badge { background: #ff6b6b; }
    .user-badge { background: #4da6ff; }

    .main-container {
      height: 100vh;
      position: relative;
    }
    #video-player {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
    .chat-overlay {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 38%;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,255,255,0.15);
      display: flex;
      flex-direction: column;
      z-index: 50;
    }
    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .message {
      margin: 10px 0;
      padding: 10px 16px;
      border-radius: 14px;
      max-width: 80%;
      word-wrap: break-word;
      line-height: 1.5;
    }
    .message.self {
      background: linear-gradient(135deg, #4da6ff, #6b8cff);
      margin-left: auto;
    }
    .message.other {
      background: rgba(255,255,255,0.12);
    }
    .username {
      font-weight: 700;
      font-size: 0.9em;
      display: block;
      margin-bottom: 4px;
      color: #a0c4ff;
    }
    #chat-form {
      display: flex;
      padding: 15px 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    #message-input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      border-radius: 30px 0 0 30px;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    #chat-form button {
      padding: 12px 24px;
      border: none;
      background: #4da6ff;
      color: white;
      border-radius: 0 30px 30px 0;
      cursor: pointer;
    }
    .status {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 8px 16px;
      border-radius: 30px;
      font-size: 0.9em;
      z-index: 60;
    }
  </style>
</head>
<body>

<!-- فرم ورود اولیه -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <h1 class="login-title">واچ پارتی</h1>
    
    <div class="input-group">
      <input type="text" id="username" placeholder=" " required>
      <label for="username">نام نمایشی</label>
    </div>

    <div class="input-group">
      <input type="password" id="password" placeholder=" " required>
      <label for="password">رمز عبور</label>
    </div>

    <button class="btn btn-owner" onclick="login('owner')">ورود به عنوان مالک</button>
    <button class="btn btn-user" onclick="login('user')">ورود به عنوان کاربر</button>

    <p class="error-msg" id="loginError"></p>
  </div>
</div>

<!-- صفحه اصلی -->
<div class="main-container" id="mainContainer" style="display:none;">
  <header>
    <a href="../index.html" class="logo-link">← بازگشت</a>
    <div class="user-info">
      <span id="displayName">...</span>
      <span class="role-badge" id="roleBadge">کاربر</span>
    </div>
  </header>

  <video id="video-player" controls></video>
  <div class="status" id="status">در حال اتصال...</div>

  <div class="chat-overlay">
    <div id="messages"></div>
    <form id="chat-form">
      <input type="text" id="message-input" placeholder="پیام خود را بنویسید..." autocomplete="off" />
      <button type="submit"><i class="fas fa-paper-plane"></i></button>
    </form>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCZVi8SyjtW6dxMHDX7D0lZEdF5XPLtwJA",
  authDomain: "softshiraz-2ddce.firebaseapp.com",
  databaseURL: "https://softshiraz-2ddce-default-rtdb.firebaseio.com/",
  projectId: "softshiraz-2ddce",
  storageBucket: "softshiraz-2ddce.firebasestorage.app",
  messagingSenderId: "760975223534",
  appId: "1:760975223534:web:3008a1fbcc09a2ae2fe1ff",
  measurementId: "G-MRLRFEVB3D"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const videoStateRef = db.ref('watchparty/videoState');
const messagesRef = db.ref('watchparty/messages').limitToLast(300);

let currentUser = { uid: null, displayName: null, role: 'user' };
let isOwner = false;

const VIDEO_URL = "https://s1.dlserfes.info/dl1/2018/Tag%202018/Tag_2018_720p_BrRip_YIFY.mkv?md5=JgOv4DHH-E856mk-iRe8Aw&u=288589&expires=1766897453";

const OWNER_PASS = "0000";
const USER_PASS = "1234";

// لاگین
function login(role) {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const errorEl = document.getElementById('loginError');

  if (!username) {
    errorEl.textContent = 'لطفاً نام خود را وارد کنید';
    return;
  }

  if (role === 'owner' && password !== OWNER_PASS) {
    errorEl.textContent = 'رمز مالک اشتباه است!';
    return;
  }
  if (role === 'user' && password !== USER_PASS) {
    errorEl.textContent = 'رمز کاربر اشتباه است!';
    return;
  }

  // ذخیره اطلاعات کاربر
  currentUser = {
    uid: 'user_' + Math.random().toString(36).substr(2, 9),
    displayName: username,
    role: role
  };
  isOwner = (role === 'owner');

  localStorage.setItem('watchparty_user', JSON.stringify(currentUser));

  // نمایش صفحه اصلی
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainContainer').style.display = 'block';

  document.getElementById('displayName').textContent = username;
  document.getElementById('roleBadge').textContent = isOwner ? 'مالک' : 'کاربر';
  document.getElementById('roleBadge').className = `role-badge ${isOwner ? 'owner-badge' : 'user-badge'}`;

  initVideoSync();
  loadMessages();
}

// سینک ویدیو
let isUserSeeking = false;

function initVideoSync() {
  const video = document.getElementById('video-player');
  video.src = VIDEO_URL;
  video.load();

  // فقط مالک می‌تواند کنترل کند
  video.addEventListener('play', () => { 
    if (isOwner && !isUserSeeking) videoStateRef.update({ playing: true, currentTime: video.currentTime }); 
  });
  video.addEventListener('pause', () => { 
    if (isOwner && !isUserSeeking) videoStateRef.update({ playing: false, currentTime: video.currentTime }); 
  });
  video.addEventListener('seeking', () => { isUserSeeking = true; });
  video.addEventListener('seeked', () => {
    if (isOwner) videoStateRef.update({ currentTime: video.currentTime });
    isUserSeeking = false;
  });

  // دریافت وضعیت از Firebase
  videoStateRef.on('value', snapshot => {
    const state = snapshot.val();
    if (!state) return;

    if (Math.abs(video.currentTime - state.currentTime) > 3) {
      video.currentTime = state.currentTime;
    }

    if (state.playing && video.paused) {
      video.play().catch(() => {});
    } else if (!state.playing && !video.paused) {
      video.pause();
    }
  });

  // پخش خودکار (اگر قبلاً شروع شده)
  videoStateRef.once('value').then(snap => {
    const state = snap.val();
    if (state && state.playing) {
      video.currentTime = state.currentTime || 0;
      video.play().catch(() => {});
    }
  });
}

// چت
function loadMessages() {
  messagesRef.on('child_added', snapshot => {
    const msg = snapshot.val();
    const div = document.createElement('div');
    div.className = `message ${msg.uid === currentUser.uid ? 'self' : 'other'}`;
    div.innerHTML = `<span class="username">${msg.displayName}</span>${msg.text}`;
    document.getElementById('messages').appendChild(div);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  });
}

document.getElementById('chat-form').addEventListener('submit', e => {
  e.preventDefault();
  const text = document.getElementById('message-input').value.trim();
  if (text && currentUser.displayName) {
    messagesRef.push({
      text: text,
      displayName: currentUser.displayName,
      uid: currentUser.uid,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
    document.getElementById('message-input').value = '';
  }
});

// شروع برنامه - اگر قبلاً وارد شده بود
const savedUser = localStorage.getItem('watchparty_user');
if (savedUser) {
  currentUser = JSON.parse(savedUser);
  isOwner = currentUser.role === 'owner';
  
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainContainer').style.display = 'block';

  document.getElementById('displayName').textContent = currentUser.displayName;
  document.getElementById('roleBadge').textContent = isOwner ? 'مالک' : 'کاربر';
  document.getElementById('roleBadge').className = `role-badge ${isOwner ? 'owner-badge' : 'user-badge'}`;

  initVideoSync();
  loadMessages();
}
</script>
</body>
</html>