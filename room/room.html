<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± Ø·Ù„Ø§ÛŒÙ€ÛŒ | Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ</title>
    <style>
        :root { --gold: #d4af37; --black: #0f0f0f; --gray: #1e1e1e; --input-bg: #2a2a2a; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--black); font-family: system-ui, -apple-system, Tahoma, sans-serif;
            overflow: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù„ ØµÙØ­Ù‡ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }

        /* ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† */
        #auth-page {
            display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px;
        }
        .login-card {
            background: var(--gray); border: 1px solid var(--gold); border-radius: 20px;
            padding: 30px; width: 100%; max-width: 350px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú†Øª */
        #chat-page { display: none; flex-direction: column; height: 100%; }

        header {
            background: var(--gray); padding: 12px 20px; border-bottom: 1px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #message-area {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px;
            background: radial-gradient(circle at center, #1a1a1a 0%, #0f0f0f 100%);
        }

        .msg-bubble {
            max-width: 85%; padding: 10px 15px; border-radius: 18px; position: relative;
            background: var(--gray); border-right: 3px solid var(--gold); animation: slideUp 0.2s ease;
        }
        .my-bubble {
            align-self: flex-end; background: #333; border-right: none; border-left: 3px solid var(--gold);
            border-bottom-right-radius: 4px;
        }
        .other-bubble { align-self: flex-start; border-bottom-left-radius: 4px; }

        .sender-name { color: var(--gold); font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; display: block; }
        .msg-text { color: #eee; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .msg-info { font-size: 0.65rem; color: #888; margin-top: 5px; display: flex; justify-content: space-between; }

        .input-bar {
            background: var(--gray); padding: 12px; display: flex; gap: 8px;
            border-top: 1px solid #333; padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        input {
            background: var(--input-bg); border: 1px solid #444; color: white;
            padding: 12px 15px; border-radius: 25px; outline: none; flex: 1; font-size: 16px; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø´Ø¯Ù† Ø¯Ø± Ø¢ÛŒÙÙˆÙ† */
        }
        input:focus { border-color: var(--gold); }

        button {
            background: linear-gradient(45deg, #aa8a2e, #d4af37); border: none;
            padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer;
        }
        
        .del-btn { color: #ff5555; cursor: pointer; margin-right: 8px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ */
        @media (min-width: 768px) {
            #message-area { padding: 30px 20% ; }
            .msg-bubble { max-width: 60%; }
        }
    </style>
</head>
<body>

    <div id="auth-page">
        <div class="login-card">
            <h2 style="color: var(--gold); margin-top: 0;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØªØ§Ù„Ø§Ø±</h2>
            <input type="text" id="userInp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
            <input type="password" id="passInp" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
            <button onclick="handleLogin()" style="width: 100%; margin-top: 15px;">ØªØ§ÛŒÛŒØ¯ ÙˆØ±ÙˆØ¯</button>
        </div>
    </div>

    <div id="chat-page">
        <header>
            <span id="header-user" style="color: var(--gold); font-weight: bold;"></span>
            <button onclick="logout()" style="background: transparent; color: #ff5555; border: 1px solid #ff5555; padding: 5px 12px; font-size: 12px;">Ø®Ø±ÙˆØ¬</button>
        </header>
        
        <div id="message-area"></div>

        <div class="input-bar">
            <input type="text" id="msgInp" placeholder="Ù¾ÛŒØ§Ù…..." autocomplete="off">
            <button onclick="handleSend()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let lastMsgCount = 0;

    window.onload = () => {
        if(localStorage.getItem('chat_u')) initChat();
    };

    async function handleLogin() {
        const u = document.getElementById('userInp').value.trim();
        const p = document.getElementById('passInp').value.trim();
        if(!u || !p) return alert("Ù„Ø·ÙØ§ Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯");

        try {
            const res = await fetch(API, {
                method: 'POST',
                body: JSON.stringify({ type: 'login', username: u, password: p })
            });
            if(res.ok) {
                localStorage.setItem('chat_u', u);
                localStorage.setItem('chat_p', p);
                initChat();
            } else {
                const err = await res.json();
                alert(err.error);
            }
        } catch(e) { alert("Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„"); }
    }

    function initChat() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        document.getElementById('header-user').innerText = "ğŸ‘¤ " + localStorage.getItem('chat_u');
        refresh();
        setInterval(refresh, 2500);
    }

    async function refresh() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            const area = document.getElementById('message-area');
            const myU = localStorage.getItem('chat_u');
            const myP = localStorage.getItem('chat_p');

            const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 150;

            area.innerHTML = data.map(m => `
                <div class="msg-bubble ${m.username === myU ? 'my-bubble' : 'other-bubble'}">
                    <span class="sender-name">${m.username} ${m.isAdmin ? 'ğŸ‘‘' : ''}</span>
                    <div class="msg-text">${m.text}</div>
                    <div class="msg-info">
                        <span>${m.time}</span>
                        ${myP === '1111' ? `<span class="del-btn" onclick="delMsg('${m.id}')">Ø­Ø°Ù</span>` : ''}
                    </div>
                </div>
            `).join('');

            if(isBottom) area.scrollTop = area.scrollHeight;
        } catch(e) {}
    }

    async function handleSend() {
        const inp = document.getElementById('msgInp');
        if(!inp.value.trim()) return;
        
        const txt = inp.value;
        inp.value = ""; 

        await fetch(API, {
            method: 'POST',
            body: JSON.stringify({
                username: localStorage.getItem('chat_u'),
                password: localStorage.getItem('chat_p'),
                text: txt
            })
        });
        refresh();
    }

    async function delMsg(id) {
        if(!confirm("Ù¾ÛŒØ§Ù… Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
        await fetch(API, {
            method: 'DELETE',
            body: JSON.stringify({ messageId: id, adminPassword: localStorage.getItem('chat_p') })
        });
        refresh();
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    document.getElementById('msgInp').onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
</script>
</body>
</html>
