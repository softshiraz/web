<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªÙ€Ø§Ù„Ø§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ VIP</title>
    <style>
        :root { --gold: #d4af37; --black: #0d0d0d; --gray: #1a1a1a; }
        * { box-sizing: border-box; font-family: Tahoma, sans-serif; transition: 0.2s; }
        body { background: var(--black); color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Ø¢ÙˆØ§ØªØ§Ø± */
        .avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--gold); vertical-align: middle; margin-left: 8px; }
        
        header { padding: 10px; background: var(--gray); border-bottom: 1px solid var(--gold); font-size: 11px; }
        #typing-status { color: var(--gold); height: 15px; margin-top: 5px; font-style: italic; }

        .room-selector { display: flex; background: #000; padding: 5px; gap: 5px; }
        .room-btn { flex: 1; padding: 8px; font-size: 11px; background: #222; color: #888; border: none; cursor: pointer; border-radius: 5px; }
        .room-btn.active { background: var(--gold); color: black; font-weight: bold; }

        #chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 15px; background: var(--gray); position: relative; border-right: 3px solid var(--gold); }
        .my-msg { align-self: flex-end; border-right: none; border-left: 3px solid var(--gold); background: #252525; }
        
        .reply-box { background: rgba(255,255,255,0.05); border-radius: 5px; padding: 5px; margin-bottom: 5px; border-right: 2px solid var(--gold); font-size: 10px; color: #aaa; }
        
        .input-bar { padding: 15px; background: var(--gray); display: flex; flex-direction: column; gap: 5px; }
        #reply-indicator { display: none; background: #333; padding: 5px 10px; font-size: 11px; border-radius: 5px; justify-content: space-between; color: var(--gold); }

        #voice-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #333; color: white; cursor: pointer; }
        #voice-btn.recording { background: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .btn-send { background: var(--gold); border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-page" style="display:flex; justify-content:center; align-items:center; height:100%; background:#000;">
        <div style="background:var(--gray); padding:30px; border-radius:20px; border:1px solid var(--gold); width:300px; text-align:center;">
            <h3 style="color:var(--gold)">ÙˆØ±ÙˆØ¯ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
            <input type="text" id="u" placeholder="Ù†Ø§Ù…" style="width:100%; padding:10px; margin:10px 0; background:#222; color:white; border:1px solid #444; border-radius:8px;">
            <input type="password" id="p" placeholder="Ø±Ù…Ø²" style="width:100%; padding:10px; margin-bottom:15px; background:#222; color:white; border:1px solid #444; border-radius:8px;">
            <button class="btn-send" style="width:100%" onclick="login()">ØªØ§ÛŒÛŒØ¯</button>
        </div>
    </div>

    <div id="chat-page" style="display:none; flex-direction:column; height:100%;">
        <div class="room-selector">
            <button class="room-btn active" id="btn-general" onclick="changeRoom('general')">ØªØ§Ù„Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ</button>
            <button class="room-btn" id="btn-vip" onclick="changeRoom('vip')">Ø¨Ø®Ø´ ÙˆÛŒÚ˜Ù‡ Ø§Ø¯Ù…ÛŒÙ†</button>
        </div>
        <header>
            <div id="online-list">ğŸŸ¢ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ù†Ù„Ø§ÛŒÙ†...</div>
            <div id="typing-status"></div>
        </header>

        <div id="chat-area"></div>

        <div class="input-area">
            <div id="reply-indicator">
                <span id="reply-text"></span>
                <b onclick="cancelReply()" style="cursor:pointer">âœ–</b>
            </div>
            <div class="input-bar" style="flex-direction:row">
                <button id="voice-btn" onmousedown="startRec()" onmouseup="stopRec()" ontouchstart="startRec()" ontouchend="stopRec()">ğŸ¤</button>
                <input type="text" id="m" placeholder="Ù¾ÛŒØ§Ù…..." style="flex:1; padding:12px; border-radius:20px; background:#222; border:1px solid #444; color:white;" oninput="imTyping()">
                <button class="btn-send" onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

<script>
    const API = "https://room.softshiraz.workers.dev/";
    let currentRoom = 'general', replyTo = null, isTyping = false;
    let refreshInt, heartInt;

    async function login() {
        const u = document.getElementById('u').value, p = document.getElementById('p').value;
        const res = await fetch(API, { method: 'POST', body: JSON.stringify({ type: 'login', password: p }) });
        if((await res.json()).success) {
            localStorage.setItem('chat_u', u); localStorage.setItem('chat_p', p);
            init();
        } else alert("Ø±Ù…Ø² ØºÙ„Ø·");
    }

    function init() {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('chat-page').style.display = 'flex';
        heartInt = setInterval(heartbeat, 4000);
        refreshInt = setInterval(refresh, 3000);
        refresh();
    }

    function imTyping() { isTyping = true; setTimeout(() => isTyping = false, 2000); }

    async function heartbeat() {
        fetch(`${API}?room=${currentRoom}`, { method: 'POST', body: JSON.stringify({ type: 'heartbeat', username: localStorage.getItem('chat_u'), isTyping }) });
    }

    function changeRoom(r) {
        currentRoom = r;
        document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${r}`).classList.add('active');
        document.getElementById('chat-area').innerHTML = "";
        refresh();
    }

    async function refresh() {
        const res = await fetch(`${API}?room=${currentRoom}`);
        const data = await res.json();
        const myU = localStorage.getItem('chat_u'), isAdmin = localStorage.getItem('chat_p') === '1111';
        
        const typing = data.onlineUsers.filter(u => u.isTyping && u.name !== myU).map(u => u.name);
        document.getElementById('typing-status').innerText = typing.length ? `${typing.join(' Ùˆ ')} Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†...` : "";
        document.getElementById('online-list').innerText = "ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†: " + data.onlineUsers.map(u => u.name).join('ØŒ ');

        const area = document.getElementById('chat-area');
        const isBottom = area.scrollHeight - area.scrollTop <= area.clientHeight + 100;

        area.innerHTML = data.messages.map(m => `
            <div class="msg ${m.username === myU ? 'my-msg' : ''}" onclick="setReply('${m.username}')">
                <img class="avatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=${m.username}">
                <b>${m.username} ${m.isAdmin ? 'ğŸ‘‘' : ''}</b>
                ${m.replyTo ? `<div class="reply-box">Ù¾Ø§Ø³Ø® Ø¨Ù‡: ${m.replyTo}</div>` : ''}
                <div>${m.text}</div>
                ${m.audio ? `<audio controls src="${m.audio}" style="width:180px; height:30px; filter:sepia(1);"></audio>` : ''}
                <div style="font-size:9px; color:#888; margin-top:5px;">
                    ${m.time} ${isAdmin ? `<span onclick="del('${m.id}')" style="color:#ff4444; cursor:pointer; margin-right:10px;">Ø­Ø°Ù</span>` : ''}
                </div>
            </div>
        `).join('');
        if(isBottom) area.scrollTop = area.scrollHeight;
    }

    function setReply(name) {
        replyTo = name;
        document.getElementById('reply-indicator').style.display = 'flex';
        document.getElementById('reply-text').innerText = `Ù¾Ø§Ø³Ø® Ø¨Ù‡: ${name}`;
    }

    function cancelReply() { replyTo = null; document.getElementById('reply-indicator').style.display = 'none'; }

    async function send() {
        const m = document.getElementById('m'); if(!m.value) return;
        const text = m.value; m.value = "";
        await fetch(`${API}?room=${currentRoom}`, { method: 'POST', body: JSON.stringify({
            username: localStorage.getItem('chat_u'), password: localStorage.getItem('chat_p'),
            text, replyTo
        })});
        cancelReply(); refresh();
    }

    // Ø¨Ø®Ø´ ÙˆÛŒØ³ (Ù…Ø´Ø§Ø¨Ù‡ Ù‚Ø¨Ù„ Ø¨Ø§ Ø¢Ø¯Ø±Ø³ Room)
    let recorder, chunks = [];
    async function startRec() {
        const s = await navigator.mediaDevices.getUserMedia({ audio: true });
        recorder = new MediaRecorder(s); chunks = [];
        document.getElementById('voice-btn').classList.add('recording');
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const b = new Blob(chunks, { type: 'audio/webm' });
            const r = new FileReader(); r.readAsDataURL(b);
            r.onloadend = () => {
                fetch(`${API}?room=${currentRoom}`, { method: 'POST', body: JSON.stringify({
                    username: localStorage.getItem('chat_u'), password: localStorage.getItem('chat_p'),
                    audio: r.result, replyTo
                })});
                cancelReply();
            };
        };
        recorder.start();
    }
    function stopRec() { if(recorder) { recorder.stop(); document.getElementById('voice-btn').classList.remove('recording'); } }

    async function del(id) {
        if(!confirm("Ø­Ø°ÙØŸ")) return;
        await fetch(`${API}?room=${currentRoom}`, { method: 'DELETE', body: JSON.stringify({ messageId: id, adminPassword: localStorage.getItem('chat_p') }) });
        refresh();
    }

    if(localStorage.getItem('chat_u')) init();
</script>
</body>
</html>
